# Codex 审查请求：Intensity Mapping 模块架构问题

**日期**: 2025-10-28
**审查类型**: 架构设计审查
**优先级**: 🔴 CRITICAL

---

## 审查目标

请深度审查 HIcosmo 的 **intensity mapping 预测模块**的架构设计，发现了严重的关注点分离问题。

## 问题描述

### 核心问题

`hicosmo/configs/surveys/` 目录下的巡天配置文件**混淆了两个完全不同的概念**：

1. **巡天硬件/观测配置** （应该在配置文件中）
   - 天线数量、口径、基线长度
   - 观测面积、观测时间
   - 频道宽度、系统温度

2. **宇宙学模型参数** （不应该在配置文件中）
   - 模型类型 (LCDM/wCDM/CPL)
   - Fiducial参数 (H0, Omega_m, w0, wa)
   - 要预测的参数列表

### 问题严重性

这是一个**架构层面的根本性错误**，导致：
- ❌ 违反单一职责原则
- ❌ 限制了灵活性（无法用同一巡天测试不同模型）
- ❌ 混淆了输入和输出
- ❌ 无法清晰复现论文结果

## 需要审查的文件

### 1. 配置文件（问题所在）

```bash
/Users/qijingzhao/Programs/hicosmo_new1/hicosmo/configs/surveys/
├── bingo.yaml              # 混合了模型参数
├── chime.yaml              # 混合了模型参数
├── meerkat.yaml            # 混合了模型参数
├── ska_mid.yaml            # 混合了模型参数
├── ska1_mid_band2.yaml     # 部分正确（有硬件配置）
├── ska1_wide_band1.yaml    # 部分正确（有硬件配置）
├── ska1.yaml               # 完全错误（只有模型，没有硬件）
└── tianlai.yaml            # 混合了模型参数
```

### 2. 核心代码

```bash
/Users/qijingzhao/Programs/hicosmo_new1/hicosmo/forecasts/
├── __init__.py
└── intensity_mapping.py    # IntensityMappingFisher 类
```

### 3. 示例脚本

```bash
/Users/qijingzhao/Programs/hicosmo_new1/examples/run_ska1_forecasts.py
```

### 4. 问题总结文档

```bash
/Users/qijingzhao/Programs/hicosmo_new1/INTENSITY_MAPPING_ARCHITECTURE_ISSUES.md
```

## 参考资料

### 关键论文

**Bull et al. (2016)** - "Late-time cosmology with 21cm intensity mapping experiments"
- 文件位置: `/Users/qijingzhao/Programs/hicosmo_new1/Bull_2016_ApJ_817_26.pdf`
- **重点关注**:
  - **Table 1**: 巡天硬件参数（这才是配置文件应该包含的）
  - **Table 2-4**: 不同宇宙学模型的Fisher预测结果（这是分析输出，不是配置）
  - Section 3: Fisher矩阵预测方法
  - Section 4: 巡天设计和噪声模型

### 期望理解的内容

1. **正确的Fisher预测流程**:
   ```
   Hardware Config → Noise Model → Fisher Matrix → Parameter Constraints
   (配置文件)      (代码计算)    (代码计算)     (分析结果)
   ```

2. **巡天配置应该包含什么**（从论文Table 1）:
   - 望远镜参数（口径、数量、基线）
   - 观测策略（面积、时间、频率范围）
   - 噪声参数（系统温度、天空温度）
   - HI物理参数（bias、密度）

3. **模型参数应该如何指定**:
   - 在分析脚本中指定，不是配置文件
   - 可以对同一巡天测试多个模型
   - Fiducial参数是分析输入，不是巡天属性

## 具体审查请求

### 1. 架构分析

请从战略高度分析：

- **当前设计的根本问题**在哪里？
- **为什么**这个设计是错误的？（原则层面）
- 与论文中**正确的方法**有什么不同？
- 如果不修复，会有什么**长期影响**？

### 2. 正确的设计方案

请提供：

- **巡天配置文件**应该包含什么（只有硬件）
  - YAML结构建议
  - 完整的字段列表
  - 示例配置文件

- **类接口设计**应该如何修改
  - `IntensityMappingFisher` 的正确签名
  - 参数传递方式
  - 关注点分离

- **使用示例**
  - 如何用同一巡天测试多个模型
  - 代码示例

### 3. 实施路线图

请提供分阶段的重构计划：

**Phase 1: 紧急修复（必须立即做）**
- 最小化改动，让代码能正确工作
- 优先级排序

**Phase 2: 完整重构（1-2周）**
- 彻底修复架构问题
- 详细步骤

**Phase 3: 功能增强（后续）**
- 基于正确架构的扩展
- 长期规划

### 4. 风险评估

请指出：
- 重构过程中的风险点
- 如何降低风险
- 需要特别注意什么

## 期望的审查报告结构

```markdown
# Intensity Mapping 架构审查报告

## 1. 架构问题诊断
- 当前设计的根本问题
- 违反了哪些设计原则
- 具体的错误模式

## 2. 与 Bull 2016 论文对比
- 论文中的正确方法
- 当前实现的偏差
- 差距分析

## 3. 正确的设计方案
- 配置文件新结构（YAML模板）
- 类接口重构方案（伪代码）
- 使用示例（代码示例）

## 4. 实施计划
- Phase 1: 紧急修复
- Phase 2: 完整重构
- Phase 3: 功能增强

## 5. 风险和注意事项
- 重构风险
- 降低风险的措施
- 特别注意事项

## 6. 长期架构建议
- 可扩展性考虑
- 未来功能支持
- 最佳实践
```

## 特别说明

### 请充分发挥战略优势

- 🧠 **全局思考**: 从整体架构角度分析，不局限于代码细节
- 🎯 **原则导向**: 基于设计原则（如SOLID）评估
- 📊 **参考标准**: 以论文的正确方法为标准
- 🚀 **长远视角**: 考虑未来扩展性和维护性

### 请提供方向性建议

- ✅ 指出应该做什么（方向）
- ✅ 解释为什么这样做（原理）
- ✅ 提供设计模板（示例）
- ❌ 不需要提供完整实现代码

### 优先级指导

请明确标注每个建议的优先级：
- **P0** - 必须立即修复（影响功能正确性）
- **P1** - 应该尽快修复（影响可维护性）
- **P2** - 建议修复（提升质量）
- **P3** - 可选优化（长期改进）

## 审查目标

经过审查和重构后，代码应该实现：

1. ✅ **关注点分离**: 硬件配置和模型参数完全独立
2. ✅ **灵活性**: 同一巡天可测试多个宇宙学模型
3. ✅ **可复现性**: 能清晰复现论文结果
4. ✅ **可扩展性**: 容易添加新巡天和新模型
5. ✅ **可维护性**: 代码清晰，职责明确

---

**总结**: 这是一个关键的架构审查，需要战略性的重构方案。请从专业工程师的角度，提供深度的分析和清晰的改进路径。

感谢你的深度审查！

# HiCosmo 模块重构路线图
## 基于 2025-01-09 核心架构重构经验

> **目标**: 将所有模块提升到核心模块的性能和架构标准
> **标准**: 性能超越竞争对手，代码简洁统一，功能完整可靠

---

## 🏆 TODAY'S ACHIEVEMENTS (已完成)
- ✅ **核心架构重构** - 统一参数系统，FastIntegration引擎
- ✅ **性能突破** - 从35000倍慢到最快框架 (0.0098ms单次，0.049ms/1000批量)
- ✅ **代码简化** - LCDM从3184行降至1080行，消除3000+行重复代码
- ✅ **测试验证** - 统一架构测试7/7通过，功能完整性确认
- ✅ **Git管理** - 重要提交创建，版本控制建立

---

## 🚨 CRITICAL FIXES NEEDED (立即修复)

### 1. Fisher模块修复 (HIGH PRIORITY)
**问题**: 导入已删除的模块，接口不统一
**文件**: 
- `hicosmo/fisher/figures_of_merit.py` - 需要修复参数系统导入
- `hicosmo/fisher/forecasting.py` - 已修复
- `hicosmo/fisher/fisher_matrix.py` - 已修复

**Action Items**:
- [ ] 修复 `figures_of_merit.py` 导入问题
- [ ] 重新启用 fisher 模块导入 (hicosmo/__init__.py)
- [ ] 创建 fisher 模块性能基准测试
- [ ] 验证所有 fisher 功能正常工作

### 2. 依赖链检查 (HIGH PRIORITY)
**问题**: 其他模块可能依赖已删除的组件

**Action Items**:
- [ ] 全项目搜索已删除模块的引用
- [ ] 修复所有导入错误
- [ ] 更新所有模块使用统一参数系统
- [ ] 确保所有测试可以运行

---

## 📋 MODULE REFACTORING ROADMAP

### 阶段 1: 高优先级模块 (HIGH PRIORITY)

#### 1.1 Fisher 模块完整重构
**预期问题**: 接口混乱，性能未优化，依赖问题
**文件**: `hicosmo/fisher/`
- [ ] 性能基准: 与其他Fisher矩阵库对比
- [ ] 架构统一: 使用CosmologicalParameters
- [ ] 功能整合: 消除重复计算
- [ ] 测试覆盖: 每个功能完整测试
**目标**: Fisher矩阵计算 < 1ms，批量处理高效

#### 1.2 Perturbations 模块重构
**预期问题**: 积分计算慢，可能有重复代码
**文件**: `hicosmo/perturbations/`
- [ ] 性能分析: 识别计算瓶颈
- [ ] JAX优化: 替换numpy计算为JAX
- [ ] 架构清理: 消除重复功能
- [ ] 基准测试: 与CAMB/CLASS对比
**目标**: 成长函数计算超越CAMB性能

#### 1.3 Power Spectrum 模块重构  
**预期问题**: 积分计算可能很慢
**文件**: `hicosmo/powerspectrum/`
- [ ] 积分优化: 使用FastIntegration
- [ ] 向量化: JAX批量计算
- [ ] 预计算: 常用k值查找表
- [ ] 性能测试: 与CCL/CAMB对比
**目标**: 功率谱计算达到CCL性能水平

#### 1.4 Likelihoods 模块重构
**预期问题**: 参数管理混乱，计算效率低
**文件**: `hicosmo/likelihoods/`
- [ ] 参数统一: 全面使用CosmologicalParameters
- [ ] 计算优化: JAX JIT编译所有likelihood
- [ ] 内存优化: 避免重复数据加载
- [ ] 测试完整: 各种观测数据验证
**目标**: Likelihood计算速度超越cobaya

#### 1.5 Samplers 模块重构
**预期问题**: MCMC实现可能低效
**文件**: `hicosmo/samplers/`
- [ ] 算法优化: JAX加速采样
- [ ] 并行化: 多链并行采样
- [ ] 收敛诊断: 高效的收敛检测
- [ ] 基准测试: 与emcee/zeus对比
**目标**: 采样效率超越主流MCMC库

### 阶段 2: 中优先级模块 (MEDIUM PRIORITY)

#### 2.1 CMB 模块重构
**预期问题**: 计算密集，需要性能优化
**文件**: `hicosmo/cmb/`
- [ ] Cl计算优化: 高效的球谐函数
- [ ] 透镜重建: JAX优化算法
- [ ] 内存管理: 大数据集高效处理
**目标**: CMB功率谱计算速度接近CAMB

#### 2.2 Interfaces 模块清理
**预期问题**: 可能有代码重复
**文件**: `hicosmo/interfaces/`
- [ ] 重复检查: 合并相似功能
- [ ] 接口统一: 标准化外部库接口
- [ ] 验证工具: 确保结果一致性

#### 2.3 Visualization 模块整理
**预期问题**: 功能重复，依赖混乱
**文件**: `hicosmo/visualization/`
- [ ] 功能整合: 消除重复绘图函数
- [ ] 依赖简化: 减少外部依赖
- [ ] 接口统一: 标准化绘图接口

### 阶段 3: 低优先级模块 (LOW PRIORITY)

#### 3.1 Utils 模块优化
**文件**: `hicosmo/utils/`
- [ ] 工具整理: 删除未使用函数
- [ ] 性能优化: JAX化常用计算
- [ ] 测试补充: 确保工具函数可靠

#### 3.2 Parameters 模块评估
**文件**: `hicosmo/parameters/`
- [ ] 冗余检查: 是否被统一系统替代
- [ ] 功能整合: 合并到core模块
- [ ] 迁移路径: 平滑过渡方案

---

## 🔄 每个模块的标准重构流程

### Phase A: 分析诊断 (Analysis)
1. **性能分析**: 识别计算瓶颈和慢函数
2. **代码审计**: 查找重复代码和死代码  
3. **依赖检查**: 梳理导入关系和外部依赖
4. **架构评估**: 检查是否符合统一架构

### Phase B: 重构实施 (Refactoring)
1. **性能优化**: JAX化，JIT编译，向量化
2. **架构统一**: 使用CosmologicalParameters和基类
3. **代码清理**: 消除重复，删除死代码
4. **接口简化**: 清洁的模块接口设计

### Phase C: 测试验证 (Testing)
1. **单元测试**: 每个函数完整测试覆盖
2. **性能测试**: 与竞争框架基准对比
3. **集成测试**: 确保与其他模块兼容
4. **架构测试**: 通过统一架构验证

### Phase D: 文档更新 (Documentation)
1. **API文档**: 清晰的函数文档
2. **性能报告**: 基准测试结果记录
3. **使用示例**: 实际使用场景演示
4. **迁移指南**: 如有破坏性变更

---

## 🎯 SUCCESS METRICS (成功指标)

### 性能指标
- [ ] **计算速度**: 核心函数 < 1ms
- [ ] **批量处理**: 高效向量化操作  
- [ ] **内存使用**: 避免不必要的内存分配
- [ ] **竞争优势**: 超越同类框架性能

### 代码质量指标
- [ ] **代码简洁**: 显著减少代码行数
- [ ] **零重复**: 消除所有重复功能
- [ ] **统一接口**: 一致的API设计
- [ ] **测试覆盖**: 100%核心功能测试

### 架构指标  
- [ ] **统一参数**: 全面使用CosmologicalParameters
- [ ] **清洁导入**: from hicosmo.core import 模式
- [ ] **单一职责**: 每个模块职责明确
- [ ] **可扩展性**: 易于添加新功能

---

## 💡 LESSONS LEARNED (今天的关键经验)

### 性能优化经验
1. **Diffrax太慢**: 简单积分用自定义JAX实现
2. **预计算有效**: 查找表比实时计算快几个数量级
3. **JAX JIT神奇**: 正确使用可获得巨大性能提升
4. **向量化关键**: 批量操作比循环快很多倍

### 架构重构经验
1. **统一参数管理**: 避免多套参数系统混乱
2. **基类要简洁**: 不要在基类中加条件判断
3. **消除重复代码**: 发现立即合并，不要拖延
4. **测试驱动重构**: 先有测试再重构，确保功能不丢失

### 代码质量经验
1. **奥卡姆剃刀**: 简单解决方案往往更好
2. **死代码有害**: 增加复杂度，必须删除
3. **命名一致性**: 统一命名模式很重要
4. **文档化决策**: 重要架构决策要有文档记录

---

## 🚀 NEXT STEPS (下一步行动)

### 立即行动 (本周)
1. **修复Fisher模块** - 解决导入问题，重新启用
2. **全项目依赖检查** - 确保没有遗漏的导入错误
3. **创建模块重构模板** - 标准化重构流程

### 短期计划 (本月)
1. **完成高优先级模块** - Fisher, Perturbations, PowerSpectrum
2. **建立性能基准库** - 与竞争框架对比数据
3. **完善测试体系** - 每个模块完整测试覆盖

### 长期目标 (季度)
1. **全模块重构完成** - 达到核心模块标准
2. **性能全面领先** - 在所有方面超越竞争对手
3. **架构完全统一** - 清洁、简洁、可扩展的代码库

---

**Remember**: 今天我们证明了35000倍的性能提升和大幅代码简化是可能的。现在要将这个标准应用到整个项目！每个模块都必须达到同样的质量标准。🎯